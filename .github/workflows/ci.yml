name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

concurrency:
  group: ci-${{ github.ref }}-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  version-consistency:
    name: Check Version Consistency
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      should_tag: ${{ steps.get_version.outputs.should_tag }}
      branch_type: ${{ steps.get_version.outputs.branch_type }}

    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check version consistency
        id: get_version
        run: npm run ci:version-check

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    needs: [version-consistency]

    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Lint code
        run: npm run lint || echo "No lint script found"

      - name: Build frontend
        run: npm run build

      - name: Run tests
        run: npm run ci:test-frontend

  test-backend:
    name: Test Rust Backend
    runs-on: ubuntu-latest
    needs: [version-consistency]

    steps:
      - uses: actions/checkout@v5

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: Install dependencies (Ubuntu only)
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Check Rust code
        working-directory: src-tauri
        run: cargo check

      - name: Run Rust tests
        run: npm run ci:test-backend

  build-tauri:
    name: Build Tauri App
    runs-on: ${{ matrix.platform }}
    needs: [test-frontend, test-backend]

    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, ubuntu-latest, windows-latest]

    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Build Tauri app (test build only)
        run: npm run ci:test-build ${{ matrix.platform }}

  create-tag:
    name: Create Tag
    runs-on: ubuntu-latest
    needs: [version-consistency, test-frontend, test-backend, build-tauri]
    if: needs.version-consistency.outputs.should_tag == 'true' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate release notes
        id: release_notes
        run: |
          # Generate release notes from changelog using Node.js script
          RELEASE_NOTES=$(node scripts/github-utils.cjs release-notes)
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create and push tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.version-consistency.outputs.version }}"
          BRANCH_TYPE="${{ needs.version-consistency.outputs.branch_type }}"

          echo "## üè∑Ô∏è Creating Release Tag" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Create appropriate tag based on branch
          if [ "$BRANCH_TYPE" = "production" ]; then
            # Production release from main branch
            echo "**Tag Type:** üöÄ Production Release" >> $GITHUB_STEP_SUMMARY
            echo "**Tag Name:** \`v$VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "**Source Branch:** \`main\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            node scripts/github-utils.cjs create-tag "$VERSION" "Release v$VERSION"
            echo "TAG=v$VERSION" >> $GITHUB_ENV

            echo "‚úÖ **Successfully created production tag:** \`v$VERSION\`" >> $GITHUB_STEP_SUMMARY
          elif [ "$BRANCH_TYPE" = "prerelease" ]; then
            # Pre-release from develop branch
            PRERELEASE_TAG="$VERSION-beta"
            echo "**Tag Type:** üß™ Pre-release" >> $GITHUB_STEP_SUMMARY
            echo "**Tag Name:** \`v$PRERELEASE_TAG\`" >> $GITHUB_STEP_SUMMARY
            echo "**Source Branch:** \`develop\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            node scripts/github-utils.cjs create-tag "$PRERELEASE_TAG" "Pre-release v$PRERELEASE_TAG"
            echo "TAG=v$PRERELEASE_TAG" >> $GITHUB_ENV

            echo "‚úÖ **Successfully created pre-release tag:** \`v$PRERELEASE_TAG\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Trigger release workflow
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use the tag that was just created
          TAG_TO_RELEASE="$TAG"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üöÄ Triggering Release Workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release Tag:** \`$TAG_TO_RELEASE\`" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** \`tag-release.yml\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Trigger the tag-release workflow using Node.js script
          if node scripts/github-utils.cjs trigger-release "$TAG_TO_RELEASE"; then
            echo "‚úÖ **Release workflow triggered successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üîó [View Release Workflow](https://github.com/${{ github.repository }}/actions/workflows/tag-release.yml)" >> $GITHUB_STEP_SUMMARY
            echo "üîó [View All Releases](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Failed to trigger release workflow**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  workflow-summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs:
      [
        version-consistency,
        test-frontend,
        test-backend,
        build-tauri,
        create-tag,
      ]
    if: always()

    steps:
      - name: Generate Final Summary
        run: |
          echo "# üéØ S3 Deck CI/CD Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Version and branch info
          echo "## üìã Build Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`${{ needs.version-consistency.outputs.version || 'N/A' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch Type** | \`${{ needs.version-consistency.outputs.branch_type || 'N/A' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Job status summary
          echo "## üìä Job Status Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          VERSION_STATUS="${{ needs.version-consistency.result }}"
          FRONTEND_STATUS="${{ needs.test-frontend.result }}"
          BACKEND_STATUS="${{ needs.test-backend.result }}"
          BUILD_STATUS="${{ needs.build-tauri.result }}"
          TAG_STATUS="${{ needs.create-tag.result }}"

          if [ "$VERSION_STATUS" = "success" ]; then
            echo "‚úÖ **Version Consistency:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Version Consistency:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$FRONTEND_STATUS" = "success" ]; then
            echo "‚úÖ **Frontend Tests:** Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "$FRONTEND_STATUS" = "failure" ]; then
            echo "‚ùå **Frontend Tests:** Failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚è≠Ô∏è **Frontend Tests:** Skipped" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$BACKEND_STATUS" = "success" ]; then
            echo "‚úÖ **Backend Tests:** Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "$BACKEND_STATUS" = "failure" ]; then
            echo "‚ùå **Backend Tests:** Failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚è≠Ô∏è **Backend Tests:** Skipped" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$BUILD_STATUS" = "success" ]; then
            echo "‚úÖ **Build Tests:** Passed (All Platforms)" >> $GITHUB_STEP_SUMMARY
          elif [ "$BUILD_STATUS" = "failure" ]; then
            echo "‚ùå **Build Tests:** Failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚è≠Ô∏è **Build Tests:** Skipped" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$TAG_STATUS" = "success" ]; then
            echo "‚úÖ **Tag Creation:** Success" >> $GITHUB_STEP_SUMMARY
          elif [ "$TAG_STATUS" = "failure" ]; then
            echo "‚ùå **Tag Creation:** Failed" >> $GITHUB_STEP_SUMMARY
          elif [ "$TAG_STATUS" = "skipped" ]; then
            echo "‚è≠Ô∏è **Tag Creation:** Skipped (Not a release branch)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚è≠Ô∏è **Tag Creation:** Not applicable" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [ "$VERSION_STATUS" = "success" ] && [ "$FRONTEND_STATUS" = "success" ] && [ "$BACKEND_STATUS" = "success" ] && [ "$BUILD_STATUS" = "success" ]; then
            echo "## üéâ Overall Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All checks passed! " >> $GITHUB_STEP_SUMMARY

            if [ "$TAG_STATUS" = "success" ]; then
              echo "A new release has been tagged and the release workflow has been triggered." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## ‚ùå Overall Status: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more checks failed. Please review the job details above." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîó Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- üè† [Repository](https://github.com/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
          echo "- üöÄ [Actions](https://github.com/${{ github.repository }}/actions)" >> $GITHUB_STEP_SUMMARY
          echo "- üì¶ [Releases](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY
          echo "- üìù [Changelog](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)" >> $GITHUB_STEP_SUMMARY

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [version-consistency, test-frontend, test-backend, build-tauri]
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check CHANGELOG update
        id: changelog_check
        env:
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          VERSION_STATUS: ${{ needs.version-consistency.result }}
          FRONTEND_STATUS: ${{ needs.test-frontend.result }}
          BACKEND_STATUS: ${{ needs.test-backend.result }}
          BUILD_STATUS: ${{ needs.build-tauri.result }}
          VERSION: ${{ needs.version-consistency.outputs.version }}
          PR_NUMBER: ${{ github.event.number }}
        run: npm run ci:pr-workflow

      - name: Update PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const body = process.env.PR_SUMMARY;

            // Check if there's already a comment from this bot
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('CI/CD Summary for PR')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  pr-status-check:
    name: PR Status Check
    runs-on: ubuntu-latest
    needs: [pr-summary]
    if: github.event_name == 'pull_request'
    permissions:
      statuses: write
      checks: write

    steps:
      - name: Set PR Status
        uses: actions/github-script@v7
        with:
          script: |
            const summary = '${{ needs.pr-summary.result }}';
            const prNumber = context.issue.number;

            let state, description;

            if (summary === 'success') {
              state = 'success';
              description = '‚úÖ All checks passed - Ready for review';
            } else {
              state = 'failure';
              description = '‚ùå Some checks failed - Review required';
            }

            // Create status check
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: state,
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: description,
              context: 'S3 Deck CI/CD'
            });

            // Also create a check run for better visibility
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'S3 Deck PR Summary',
              head_sha: context.payload.pull_request.head.sha,
              status: 'completed',
              conclusion: state === 'success' ? 'success' : 'failure',
              output: {
                title: state === 'success' ? 'All checks passed!' : 'Some checks failed',
                summary: `PR #${prNumber} ${state === 'success' ? 'is ready for review' : 'needs attention'}`,
                text: `View the full summary in the [workflow run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
              }
            });
